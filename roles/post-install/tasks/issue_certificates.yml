---
- name: Check if certificate already exists.
  stat:
    path: /etc/letsencrypt/live/{{ item }}/cert.pem
  register: letsencrypt_cert

- name: "Issue a certificate for each domains: {{ item }}"
  shell: "certbot --nginx -d {{ item }} --noninteractive --agree-tos --redirect --email {{ certbot_admin_email }}"
  become: true
  when: not letsencrypt_cert.stat.exists

- name: Reload nginx after certificate installation
  service:
    name: nginx
    state: reloaded
  when: not letsencrypt_cert.stat.exists
